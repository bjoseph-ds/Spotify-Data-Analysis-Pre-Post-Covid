---
title: "STAT520FINAL"
author: "Team BRAT"
date: "2024-12-02"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Suppress messages and warnings
knitr::opts_chunk$set(
  echo = TRUE,       
  warning = FALSE,   
  message = FALSE,   
  fig.width = 8,     
  fig.height = 6     
)
```

# Libraries Needed

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(corrplot)
library(randomForest)
library(caret)
library(pander)
library(knitr)
library(broom)
library(tibble)

```

# Reading Datasets

```{r}
pre_covid <- read_csv("2010-2019spotify.csv")
post_covid_2020 <- read_csv("2020spotify.csv")
post_covid_2021 <- read_csv("2021spotify.csv")
post_covid_2022 <- read_csv("2022spotify.csv")
post_covid_2023 <- read_csv("2023spotify.csv")
```

# Standardize column names across all the datasets

```{r}
# Pre-COVID renaming and processing
pre_covid <- pre_covid %>%
  rename(
    artist = artist,
    title = title,
    genre = `the genre of the track`,
    tempo = `Beats.Per.Minute -The tempo of the song`,
    energy = `Energy- The energy of a song - the higher the value, the more energtic`,
    danceability = `Danceability - The higher the value, the easier it is to dance to this song`,
    loudness = `Loudness/dB - The higher the value, the louder the song`,
    liveness = `Liveness - The higher the value, the more likely the song is a live recording`,
    valence = `Valence - The higher the value, the more positive mood for the song`,
    acousticness = `Acousticness - The higher the value the more acoustic the song is`,
    speechiness = `Speechiness - The higher the value the more spoken word the song contains`,
    duration_in_seconds = `Length - The duration of the song`
  ) %>%
  mutate(duration_in_seconds = duration_in_seconds * 1000)  # Convert duration to milliseconds for Pre-COVID

# Post-COVID 2020 processing
post_covid_2020 <- post_covid_2020 %>%
  rename(
    artist = artist,
    title = track_name,
    genre = genre,
    tempo = tempo,
    energy = energy,
    danceability = danceability,
    loudness = loudness,
    speechiness = speechiness,
    acousticness = acousticness,
    valence = valence,
    duration_in_seconds = duration_ms
  ) %>%
  mutate(year = 2020)

# Post-COVID 2021 processing
post_covid_2021 <- post_covid_2021 %>%
  rename(
    artist = artist_name,
    title = track_name,
    tempo = tempo,
    energy = energy,
    danceability = danceability,
    loudness = loudness,
    speechiness = speechiness,
    acousticness = acousticness,
    valence = valence,
    duration_in_seconds = duration_ms
  ) %>%
  mutate(year = 2021)

# Post-COVID 2022 processing
post_covid_2022 <- post_covid_2022 %>%
  rename(
    artist = `Artist Name(s)`,
    title = `Track Name`,
    genre = Genres,
    tempo = Tempo,
    energy = Energy,
    danceability = Danceability,
    loudness = Loudness,
    speechiness = Speechiness,
    acousticness = Acousticness,
    valence = Valence,
    duration_in_seconds = `Duration (ms)`
  ) %>%
  mutate(year = 2022)

# Post-COVID 2023 processing
post_covid_2023 <- post_covid_2023 %>%
  rename(
    artist = artist_name,
    title = track_name,
    genre = genres,
    tempo = tempo,
    energy = energy,
    danceability = danceability,
    loudness = loudness,
    speechiness = speechiness,
    acousticness = acousticness,
    valence = valence,
    duration_in_seconds = duration_ms
  ) %>%
  mutate(year = 2023)

pre_covid <- pre_covid %>% filter(!(year %in% c(2010, 2011, 2012, 2013, 2014)))

# Define the columns to retain
columns_to_retain <- c(
  "title", "artist", "tempo", "energy", "danceability", 
  "loudness", "liveness", "valence", "duration_in_seconds", 
  "acousticness", "speechiness", "year"
)

# Retain only necessary columns for all datasets
pre_covid <- pre_covid %>%
  select(any_of(columns_to_retain))

post_covid_2020 <- post_covid_2020 %>%
  select(any_of(columns_to_retain))

post_covid_2021 <- post_covid_2021 %>%
  select(any_of(columns_to_retain))

post_covid_2022 <- post_covid_2022 %>%
  select(any_of(columns_to_retain))

post_covid_2023 <- post_covid_2023 %>%
  select(any_of(columns_to_retain))

# Fix columns with different dist
post_covid_2020 <- post_covid_2020 %>%
  mutate(across(c(energy, danceability, liveness, valence, acousticness, speechiness), ~ . * 100))

post_covid_2021 <- post_covid_2021 %>%
  mutate(across(c(energy, danceability, liveness, valence, acousticness, speechiness), ~ . * 100))

post_covid_2023 <- post_covid_2023 %>%
  mutate(across(c(energy, danceability, liveness, valence, acousticness, speechiness), ~ . * 100))

# Print updated column names for verification after standardization
cat("Pre-COVID dataset columns (after standardizing):\n", colnames(pre_covid), "\n\n")
cat("Post-COVID 2020 dataset columns (after standardizing):\n", colnames(post_covid_2020), "\n\n")
cat("Post-COVID 2021 dataset columns (after standardizing):\n", colnames(post_covid_2021), "\n\n")
cat("Post-COVID 2022 dataset columns (after standardizing):\n", colnames(post_covid_2022), "\n\n")
cat("Post-COVID 2023 dataset columns (after standardizing):\n", colnames(post_covid_2023), "\n\n")

```

# Normalizing the datasets

```{r}
# Normalization function
normalize <- function(x) {
  (x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}

# List of required columns for normalization
required_columns <- c("danceability", "tempo", "energy", "loudness", "valence", 
                      "duration_in_seconds", "acousticness", "speechiness")

# Normalize pre-COVID dataset
pre_covid <- pre_covid %>%
  mutate(across(all_of(required_columns), normalize))

# Normalize each post-COVID dataset
post_covid_2020 <- post_covid_2020 %>%
  mutate(across(all_of(required_columns), normalize))

post_covid_2021 <- post_covid_2021 %>%
  mutate(across(all_of(required_columns), normalize))

post_covid_2022 <- post_covid_2022 %>%
  mutate(across(all_of(required_columns), normalize))

post_covid_2023 <- post_covid_2023 %>%
  mutate(across(all_of(required_columns), normalize))

# Inspect the normalized datasets
head(pre_covid)
head(post_covid_2020)
head(post_covid_2021)
head(post_covid_2022)
head(post_covid_2023)
```

# Summary Statistics

### Precovid

```{r}
# summary statistics for pre-COVID dataset
pre_covid_summary <- pre_covid %>%
  summarise(
    danceability_mean = mean(danceability, na.rm = TRUE),
    danceability_median = median(danceability, na.rm = TRUE),
    danceability_min = min(danceability, na.rm = TRUE),
    danceability_max = max(danceability, na.rm = TRUE),
    danceability_range = max(danceability, na.rm = TRUE) - min(danceability, na.rm = TRUE),
    
    tempo_mean = mean(tempo, na.rm = TRUE),
    tempo_median = median(tempo, na.rm = TRUE),
    tempo_min = min(tempo, na.rm = TRUE),
    tempo_max = max(tempo, na.rm = TRUE),
    tempo_range = max(tempo, na.rm = TRUE) - min(tempo, na.rm = TRUE),
    
    energy_mean = mean(energy, na.rm = TRUE),
    energy_median = median(energy, na.rm = TRUE),
    energy_min = min(energy, na.rm = TRUE),
    energy_max = max(energy, na.rm = TRUE),
    energy_range = max(energy, na.rm = TRUE) - min(energy, na.rm = TRUE),
    
    loudness_mean = mean(loudness, na.rm = TRUE),
    loudness_median = median(loudness, na.rm = TRUE),
    loudness_min = min(loudness, na.rm = TRUE),
    loudness_max = max(loudness, na.rm = TRUE),
    loudness_range = max(loudness, na.rm = TRUE) - min(loudness, na.rm = TRUE),
    
    valence_mean = mean(valence, na.rm = TRUE),
    valence_median = median(valence, na.rm = TRUE),
    valence_min = min(valence, na.rm = TRUE),
    valence_max = max(valence, na.rm = TRUE),
    valence_range = max(valence, na.rm = TRUE) - min(valence, na.rm = TRUE),
    
    duration_in_seconds_mean = mean(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_median = median(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_min = min(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_max = max(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_range = max(duration_in_seconds, na.rm = TRUE) - min(duration_in_seconds, na.rm = TRUE),
    
    acousticness_mean = mean(acousticness, na.rm = TRUE),
    acousticness_median = median(acousticness, na.rm = TRUE),
    acousticness_min = min(acousticness, na.rm = TRUE),
    acousticness_max = max(acousticness, na.rm = TRUE),
    acousticness_range = max(acousticness, na.rm = TRUE) - min(acousticness, na.rm = TRUE),
    
    speechiness_mean = mean(speechiness, na.rm = TRUE),
    speechiness_median = median(speechiness, na.rm = TRUE),
    speechiness_min = min(speechiness, na.rm = TRUE),
    speechiness_max = max(speechiness, na.rm = TRUE),
    speechiness_range = max(speechiness, na.rm = TRUE) - min(speechiness, na.rm = TRUE)
  )

# Simplified summary statistics calculation for pre-COVID dataset
pre_covid_summary <- pre_covid %>%
  summarise(
    Danceability = paste0("Mean: ", round(mean(danceability, na.rm = TRUE), 2), 
                          ", Median: ", round(median(danceability, na.rm = TRUE), 2), 
                          ", Range: ", round(diff(range(danceability, na.rm = TRUE)), 2)),
    Tempo = paste0("Mean: ", round(mean(tempo, na.rm = TRUE), 2), 
                   ", Median: ", round(median(tempo, na.rm = TRUE), 2), 
                   ", Range: ", round(diff(range(tempo, na.rm = TRUE)), 2)),
    Energy = paste0("Mean: ", round(mean(energy, na.rm = TRUE), 2), 
                    ", Median: ", round(median(energy, na.rm = TRUE), 2), 
                    ", Range: ", round(diff(range(energy, na.rm = TRUE)), 2)),
    Loudness = paste0("Mean: ", round(mean(loudness, na.rm = TRUE), 2), 
                      ", Median: ", round(median(loudness, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(loudness, na.rm = TRUE)), 2)),
    Valence = paste0("Mean: ", round(mean(valence, na.rm = TRUE), 2), 
                     ", Median: ", round(median(valence, na.rm = TRUE), 2), 
                     ", Range: ", round(diff(range(valence, na.rm = TRUE)), 2)),
    Duration = paste0("Mean: ", round(mean(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Median: ", round(median(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(duration_in_seconds, na.rm = TRUE)), 2))
  ) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Summary")

kable(pre_covid_summary, 
      caption = "Summary Statistics for Pre-COVID Dataset", 
      align = "c")

```

### Post Covid 2020

```{r}
# summary statistics for post-COVID 2020
post_covid_2020_summary <- post_covid_2020 %>%
  summarise(
    danceability_mean = mean(danceability, na.rm = TRUE),
    danceability_median = median(danceability, na.rm = TRUE),
    danceability_min = min(danceability, na.rm = TRUE),
    danceability_max = max(danceability, na.rm = TRUE),
    danceability_range = max(danceability, na.rm = TRUE) - min(danceability, na.rm = TRUE),
    
    tempo_mean = mean(tempo, na.rm = TRUE),
    tempo_median = median(tempo, na.rm = TRUE),
    tempo_min = min(tempo, na.rm = TRUE),
    tempo_max = max(tempo, na.rm = TRUE),
    tempo_range = max(tempo, na.rm = TRUE) - min(tempo, na.rm = TRUE),
    
    energy_mean = mean(energy, na.rm = TRUE),
    energy_median = median(energy, na.rm = TRUE),
    energy_min = min(energy, na.rm = TRUE),
    energy_max = max(energy, na.rm = TRUE),
    energy_range = max(energy, na.rm = TRUE) - min(energy, na.rm = TRUE),
    
    loudness_mean = mean(loudness, na.rm = TRUE),
    loudness_median = median(loudness, na.rm = TRUE),
    loudness_min = min(loudness, na.rm = TRUE),
    loudness_max = max(loudness, na.rm = TRUE),
    loudness_range = max(loudness, na.rm = TRUE) - min(loudness, na.rm = TRUE),
    
    valence_mean = mean(valence, na.rm = TRUE),
    valence_median = median(valence, na.rm = TRUE),
    valence_min = min(valence, na.rm = TRUE),
    valence_max = max(valence, na.rm = TRUE),
    valence_range = max(valence, na.rm = TRUE) - min(valence, na.rm = TRUE),
    
    duration_in_seconds_mean = mean(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_median = median(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_min = min(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_max = max(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_range = max(duration_in_seconds, na.rm = TRUE) - min(duration_in_seconds, na.rm = TRUE),
    
    acousticness_mean = mean(acousticness, na.rm = TRUE),
    acousticness_median = median(acousticness, na.rm = TRUE),
    acousticness_min = min(acousticness, na.rm = TRUE),
    acousticness_max = max(acousticness, na.rm = TRUE),
    acousticness_range = max(acousticness, na.rm = TRUE) - min(acousticness, na.rm = TRUE),
    
    speechiness_mean = mean(speechiness, na.rm = TRUE),
    speechiness_median = median(speechiness, na.rm = TRUE),
    speechiness_min = min(speechiness, na.rm = TRUE),
    speechiness_max = max(speechiness, na.rm = TRUE),
    speechiness_range = max(speechiness, na.rm = TRUE) - min(speechiness, na.rm = TRUE)
  )

# Simplified summary statistics calculation for post-COVID 2020 dataset
post_covid_2020_summary <- post_covid_2020 %>%
  summarise(
    Danceability = paste0("Mean: ", round(mean(danceability, na.rm = TRUE), 2), 
                          ", Median: ", round(median(danceability, na.rm = TRUE), 2), 
                          ", Range: ", round(diff(range(danceability, na.rm = TRUE)), 2)),
    Tempo = paste0("Mean: ", round(mean(tempo, na.rm = TRUE), 2), 
                   ", Median: ", round(median(tempo, na.rm = TRUE), 2), 
                   ", Range: ", round(diff(range(tempo, na.rm = TRUE)), 2)),
    Energy = paste0("Mean: ", round(mean(energy, na.rm = TRUE), 2), 
                    ", Median: ", round(median(energy, na.rm = TRUE), 2), 
                    ", Range: ", round(diff(range(energy, na.rm = TRUE)), 2)),
    Loudness = paste0("Mean: ", round(mean(loudness, na.rm = TRUE), 2), 
                      ", Median: ", round(median(loudness, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(loudness, na.rm = TRUE)), 2)),
    Valence = paste0("Mean: ", round(mean(valence, na.rm = TRUE), 2), 
                     ", Median: ", round(median(valence, na.rm = TRUE), 2), 
                     ", Range: ", round(diff(range(valence, na.rm = TRUE)), 2)),
    Duration = paste0("Mean: ", round(mean(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Median: ", round(median(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(duration_in_seconds, na.rm = TRUE)), 2))
  ) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Summary")

kable(post_covid_2020_summary, 
      caption = "Summary Statistics for Post-COVID 2020 Dataset", 
      align = "c")

```

### Post Covid 2021

```{r}
# summary statistics for post-COVID 2021
post_covid_2021_summary <- post_covid_2021 %>%
  summarise(
    danceability_mean = mean(danceability, na.rm = TRUE),
    danceability_median = median(danceability, na.rm = TRUE),
    danceability_min = min(danceability, na.rm = TRUE),
    danceability_max = max(danceability, na.rm = TRUE),
    danceability_range = max(danceability, na.rm = TRUE) - min(danceability, na.rm = TRUE),
    
    tempo_mean = mean(tempo, na.rm = TRUE),
    tempo_median = median(tempo, na.rm = TRUE),
    tempo_min = min(tempo, na.rm = TRUE),
    tempo_max = max(tempo, na.rm = TRUE),
    tempo_range = max(tempo, na.rm = TRUE) - min(tempo, na.rm = TRUE),
    
    energy_mean = mean(energy, na.rm = TRUE),
    energy_median = median(energy, na.rm = TRUE),
    energy_min = min(energy, na.rm = TRUE),
    energy_max = max(energy, na.rm = TRUE),
    energy_range = max(energy, na.rm = TRUE) - min(energy, na.rm = TRUE),
    
    loudness_mean = mean(loudness, na.rm = TRUE),
    loudness_median = median(loudness, na.rm = TRUE),
    loudness_min = min(loudness, na.rm = TRUE),
    loudness_max = max(loudness, na.rm = TRUE),
    loudness_range = max(loudness, na.rm = TRUE) - min(loudness, na.rm = TRUE),
    
    valence_mean = mean(valence, na.rm = TRUE),
    valence_median = median(valence, na.rm = TRUE),
    valence_min = min(valence, na.rm = TRUE),
    valence_max = max(valence, na.rm = TRUE),
    valence_range = max(valence, na.rm = TRUE) - min(valence, na.rm = TRUE),
    
    duration_in_seconds_mean = mean(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_median = median(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_min = min(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_max = max(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_range = max(duration_in_seconds, na.rm = TRUE) - min(duration_in_seconds, na.rm = TRUE),
    
    acousticness_mean = mean(acousticness, na.rm = TRUE),
    acousticness_median = median(acousticness, na.rm = TRUE),
    acousticness_min = min(acousticness, na.rm = TRUE),
    acousticness_max = max(acousticness, na.rm = TRUE),
    acousticness_range = max(acousticness, na.rm = TRUE) - min(acousticness, na.rm = TRUE),
    
    speechiness_mean = mean(speechiness, na.rm = TRUE),
    speechiness_median = median(speechiness, na.rm = TRUE),
    speechiness_min = min(speechiness, na.rm = TRUE),
    speechiness_max = max(speechiness, na.rm = TRUE),
    speechiness_range = max(speechiness, na.rm = TRUE) - min(speechiness, na.rm = TRUE)
  )

# Simplified summary statistics calculation for post-COVID 2021 dataset
post_covid_2021_summary <- post_covid_2021 %>%
  summarise(
    Danceability = paste0("Mean: ", round(mean(danceability, na.rm = TRUE), 2), 
                          ", Median: ", round(median(danceability, na.rm = TRUE), 2), 
                          ", Range: ", round(diff(range(danceability, na.rm = TRUE)), 2)),
    Tempo = paste0("Mean: ", round(mean(tempo, na.rm = TRUE), 2), 
                   ", Median: ", round(median(tempo, na.rm = TRUE), 2), 
                   ", Range: ", round(diff(range(tempo, na.rm = TRUE)), 2)),
    Energy = paste0("Mean: ", round(mean(energy, na.rm = TRUE), 2), 
                    ", Median: ", round(median(energy, na.rm = TRUE), 2), 
                    ", Range: ", round(diff(range(energy, na.rm = TRUE)), 2)),
    Loudness = paste0("Mean: ", round(mean(loudness, na.rm = TRUE), 2), 
                      ", Median: ", round(median(loudness, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(loudness, na.rm = TRUE)), 2)),
    Valence = paste0("Mean: ", round(mean(valence, na.rm = TRUE), 2), 
                     ", Median: ", round(median(valence, na.rm = TRUE), 2), 
                     ", Range: ", round(diff(range(valence, na.rm = TRUE)), 2)),
    Duration = paste0("Mean: ", round(mean(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Median: ", round(median(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(duration_in_seconds, na.rm = TRUE)), 2))
  ) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Summary")

kable(post_covid_2021_summary, 
      caption = "Summary Statistics for Post-COVID 2021 Dataset", 
      align = "c")

```

### Post Covid 2022

```{r}
# summary statistics for post-COVID 2022
post_covid_2022_summary <- post_covid_2022 %>%
  summarise(
    danceability_mean = mean(danceability, na.rm = TRUE),
    danceability_median = median(danceability, na.rm = TRUE),
    danceability_min = min(danceability, na.rm = TRUE),
    danceability_max = max(danceability, na.rm = TRUE),
    danceability_range = max(danceability, na.rm = TRUE) - min(danceability, na.rm = TRUE),
    
    tempo_mean = mean(tempo, na.rm = TRUE),
    tempo_median = median(tempo, na.rm = TRUE),
    tempo_min = min(tempo, na.rm = TRUE),
    tempo_max = max(tempo, na.rm = TRUE),
    tempo_range = max(tempo, na.rm = TRUE) - min(tempo, na.rm = TRUE),
    
    energy_mean = mean(energy, na.rm = TRUE),
    energy_median = median(energy, na.rm = TRUE),
    energy_min = min(energy, na.rm = TRUE),
    energy_max = max(energy, na.rm = TRUE),
    energy_range = max(energy, na.rm = TRUE) - min(energy, na.rm = TRUE),
    
    loudness_mean = mean(loudness, na.rm = TRUE),
    loudness_median = median(loudness, na.rm = TRUE),
    loudness_min = min(loudness, na.rm = TRUE),
    loudness_max = max(loudness, na.rm = TRUE),
    loudness_range = max(loudness, na.rm = TRUE) - min(loudness, na.rm = TRUE),
    
    valence_mean = mean(valence, na.rm = TRUE),
    valence_median = median(valence, na.rm = TRUE),
    valence_min = min(valence, na.rm = TRUE),
    valence_max = max(valence, na.rm = TRUE),
    valence_range = max(valence, na.rm = TRUE) - min(valence, na.rm = TRUE),
    
    duration_in_seconds_mean = mean(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_median = median(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_min = min(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_max = max(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_range = max(duration_in_seconds, na.rm = TRUE) - min(duration_in_seconds, na.rm = TRUE),
    
    acousticness_mean = mean(acousticness, na.rm = TRUE),
    acousticness_median = median(acousticness, na.rm = TRUE),
    acousticness_min = min(acousticness, na.rm = TRUE),
    acousticness_max = max(acousticness, na.rm = TRUE),
    acousticness_range = max(acousticness, na.rm = TRUE) - min(acousticness, na.rm = TRUE),
    
    speechiness_mean = mean(speechiness, na.rm = TRUE),
    speechiness_median = median(speechiness, na.rm = TRUE),
    speechiness_min = min(speechiness, na.rm = TRUE),
    speechiness_max = max(speechiness, na.rm = TRUE),
    speechiness_range = max(speechiness, na.rm = TRUE) - min(speechiness, na.rm = TRUE)
  )

# Simplified summary statistics calculation for post-COVID 2022 dataset
post_covid_2022_summary <- post_covid_2022 %>%
  summarise(
    Danceability = paste0("Mean: ", round(mean(danceability, na.rm = TRUE), 2), 
                          ", Median: ", round(median(danceability, na.rm = TRUE), 2), 
                          ", Range: ", round(diff(range(danceability, na.rm = TRUE)), 2)),
    Tempo = paste0("Mean: ", round(mean(tempo, na.rm = TRUE), 2), 
                   ", Median: ", round(median(tempo, na.rm = TRUE), 2), 
                   ", Range: ", round(diff(range(tempo, na.rm = TRUE)), 2)),
    Energy = paste0("Mean: ", round(mean(energy, na.rm = TRUE), 2), 
                    ", Median: ", round(median(energy, na.rm = TRUE), 2), 
                    ", Range: ", round(diff(range(energy, na.rm = TRUE)), 2)),
    Loudness = paste0("Mean: ", round(mean(loudness, na.rm = TRUE), 2), 
                      ", Median: ", round(median(loudness, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(loudness, na.rm = TRUE)), 2)),
    Valence = paste0("Mean: ", round(mean(valence, na.rm = TRUE), 2), 
                     ", Median: ", round(median(valence, na.rm = TRUE), 2), 
                     ", Range: ", round(diff(range(valence, na.rm = TRUE)), 2)),
    Duration = paste0("Mean: ", round(mean(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Median: ", round(median(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(duration_in_seconds, na.rm = TRUE)), 2))
  ) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Summary")

kable(post_covid_2022_summary, 
      caption = "Summary Statistics for Post-COVID 2022 Dataset", 
      align = "c")

```

### Post Covid 2023

```{r}
# summary statistics for post-COVID 2023
post_covid_2023_summary <- post_covid_2023 %>%
  summarise(
    danceability_mean = mean(danceability, na.rm = TRUE),
    danceability_median = median(danceability, na.rm = TRUE),
    danceability_min = min(danceability, na.rm = TRUE),
    danceability_max = max(danceability, na.rm = TRUE),
    danceability_range = max(danceability, na.rm = TRUE) - min(danceability, na.rm = TRUE),
    
    tempo_mean = mean(tempo, na.rm = TRUE),
    tempo_median = median(tempo, na.rm = TRUE),
    tempo_min = min(tempo, na.rm = TRUE),
    tempo_max = max(tempo, na.rm = TRUE),
    tempo_range = max(tempo, na.rm = TRUE) - min(tempo, na.rm = TRUE),
    
    energy_mean = mean(energy, na.rm = TRUE),
    energy_median = median(energy, na.rm = TRUE),
    energy_min = min(energy, na.rm = TRUE),
    energy_max = max(energy, na.rm = TRUE),
    energy_range = max(energy, na.rm = TRUE) - min(energy, na.rm = TRUE),
    
    loudness_mean = mean(loudness, na.rm = TRUE),
    loudness_median = median(loudness, na.rm = TRUE),
    loudness_min = min(loudness, na.rm = TRUE),
    loudness_max = max(loudness, na.rm = TRUE),
    loudness_range = max(loudness, na.rm = TRUE) - min(loudness, na.rm = TRUE),
    
    valence_mean = mean(valence, na.rm = TRUE),
    valence_median = median(valence, na.rm = TRUE),
    valence_min = min(valence, na.rm = TRUE),
    valence_max = max(valence, na.rm = TRUE),
    valence_range = max(valence, na.rm = TRUE) - min(valence, na.rm = TRUE),
    
    duration_in_seconds_mean = mean(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_median = median(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_min = min(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_max = max(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_range = max(duration_in_seconds, na.rm = TRUE) - min(duration_in_seconds, na.rm = TRUE),
    
    acousticness_mean = mean(acousticness, na.rm = TRUE),
    acousticness_median = median(acousticness, na.rm = TRUE),
    acousticness_min = min(acousticness, na.rm = TRUE),
    acousticness_max = max(acousticness, na.rm = TRUE),
    acousticness_range = max(acousticness, na.rm = TRUE) - min(acousticness, na.rm = TRUE),
    
    speechiness_mean = mean(speechiness, na.rm = TRUE),
    speechiness_median = median(speechiness, na.rm = TRUE),
    speechiness_min = min(speechiness, na.rm = TRUE),
    speechiness_max = max(speechiness, na.rm = TRUE),
    speechiness_range = max(speechiness, na.rm = TRUE) - min(speechiness, na.rm = TRUE)
  )

# Simplified summary statistics calculation for post-COVID 2023 dataset
post_covid_2023_summary <- post_covid_2023 %>%
  summarise(
    Danceability = paste0("Mean: ", round(mean(danceability, na.rm = TRUE), 2), 
                          ", Median: ", round(median(danceability, na.rm = TRUE), 2), 
                          ", Range: ", round(diff(range(danceability, na.rm = TRUE)), 2)),
    Tempo = paste0("Mean: ", round(mean(tempo, na.rm = TRUE), 2), 
                   ", Median: ", round(median(tempo, na.rm = TRUE), 2), 
                   ", Range: ", round(diff(range(tempo, na.rm = TRUE)), 2)),
    Energy = paste0("Mean: ", round(mean(energy, na.rm = TRUE), 2), 
                    ", Median: ", round(median(energy, na.rm = TRUE), 2), 
                    ", Range: ", round(diff(range(energy, na.rm = TRUE)), 2)),
    Loudness = paste0("Mean: ", round(mean(loudness, na.rm = TRUE), 2), 
                      ", Median: ", round(median(loudness, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(loudness, na.rm = TRUE)), 2)),
    Valence = paste0("Mean: ", round(mean(valence, na.rm = TRUE), 2), 
                     ", Median: ", round(median(valence, na.rm = TRUE), 2), 
                     ", Range: ", round(diff(range(valence, na.rm = TRUE)), 2)),
    Duration = paste0("Mean: ", round(mean(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Median: ", round(median(duration_in_seconds, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(duration_in_seconds, na.rm = TRUE)), 2))
  ) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Summary")

kable(post_covid_2023_summary, 
      caption = "Summary Statistics for Post-COVID 2023 Dataset", 
      align = "c")

```

### Combined Post-Covid data set vs. Pre-Covid data set

```{r}
# Combine the post-COVID datasets (2020-2023)
post_covid_combined <- bind_rows(post_covid_2020, post_covid_2021, post_covid_2022, post_covid_2023)

# summary statistics for post-COVID combined dataset
post_covid_combined_summary <- post_covid_combined %>%
  summarise(
    danceability_mean = mean(danceability, na.rm = TRUE),
    danceability_median = median(danceability, na.rm = TRUE),
    danceability_min = min(danceability, na.rm = TRUE),
    danceability_max = max(danceability, na.rm = TRUE),
    danceability_range = max(danceability, na.rm = TRUE) - min(danceability, na.rm = TRUE),
    
    tempo_mean = mean(tempo, na.rm = TRUE),
    tempo_median = median(tempo, na.rm = TRUE),
    tempo_min = min(tempo, na.rm = TRUE),
    tempo_max = max(tempo, na.rm = TRUE),
    tempo_range = max(tempo, na.rm = TRUE) - min(tempo, na.rm = TRUE),
    
    energy_mean = mean(energy, na.rm = TRUE),
    energy_median = median(energy, na.rm = TRUE),
    energy_min = min(energy, na.rm = TRUE),
    energy_max = max(energy, na.rm = TRUE),
    energy_range = max(energy, na.rm = TRUE) - min(energy, na.rm = TRUE),
    
    loudness_mean = mean(loudness, na.rm = TRUE),
    loudness_median = median(loudness, na.rm = TRUE),
    loudness_min = min(loudness, na.rm = TRUE),
    loudness_max = max(loudness, na.rm = TRUE),
    loudness_range = max(loudness, na.rm = TRUE) - min(loudness, na.rm = TRUE),
    
    valence_mean = mean(valence, na.rm = TRUE),
    valence_median = median(valence, na.rm = TRUE),
    valence_min = min(valence, na.rm = TRUE),
    valence_max = max(valence, na.rm = TRUE),
    valence_range = max(valence, na.rm = TRUE) - min(valence, na.rm = TRUE),
    
    duration_in_seconds_mean = mean(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_median = median(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_min = min(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_max = max(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_range = max(duration_in_seconds, na.rm = TRUE) - min(duration_in_seconds, na.rm = TRUE),
    
    acousticness_mean = mean(acousticness, na.rm = TRUE),
    acousticness_median = median(acousticness, na.rm = TRUE),
    acousticness_min = min(acousticness, na.rm = TRUE),
    acousticness_max = max(acousticness, na.rm = TRUE),
    acousticness_range = max(acousticness, na.rm = TRUE) - min(acousticness, na.rm = TRUE),
    
    speechiness_mean = mean(speechiness, na.rm = TRUE),
    speechiness_median = median(speechiness, na.rm = TRUE),
    speechiness_min = min(speechiness, na.rm = TRUE),
    speechiness_max = max(speechiness, na.rm = TRUE),
    speechiness_range = max(speechiness, na.rm = TRUE) - min(speechiness, na.rm = TRUE)
  )

# Function to summarize and format statistics
summarize_statistics <- function(data, caption) {
  # Summarize statistics
  summary_table <- data %>%
    summarise(
      Danceability = paste0("Mean: ", round(mean(danceability, na.rm = TRUE), 2), 
                            ", Median: ", round(median(danceability, na.rm = TRUE), 2), 
                            ", Range: ", round(diff(range(danceability, na.rm = TRUE)), 2)),
      Tempo = paste0("Mean: ", round(mean(tempo, na.rm = TRUE), 2), 
                     ", Median: ", round(median(tempo, na.rm = TRUE), 2), 
                     ", Range: ", round(diff(range(tempo, na.rm = TRUE)), 2)),
      Energy = paste0("Mean: ", round(mean(energy, na.rm = TRUE), 2), 
                      ", Median: ", round(median(energy, na.rm = TRUE), 2), 
                      ", Range: ", round(diff(range(energy, na.rm = TRUE)), 2)),
      Loudness = paste0("Mean: ", round(mean(loudness, na.rm = TRUE), 2), 
                        ", Median: ", round(median(loudness, na.rm = TRUE), 2), 
                        ", Range: ", round(diff(range(loudness, na.rm = TRUE)), 2)),
      Valence = paste0("Mean: ", round(mean(valence, na.rm = TRUE), 2), 
                       ", Median: ", round(median(valence, na.rm = TRUE), 2), 
                       ", Range: ", round(diff(range(valence, na.rm = TRUE)), 2)),
      Duration = paste0("Mean: ", round(mean(duration_in_seconds, na.rm = TRUE), 2), 
                        ", Median: ", round(median(duration_in_seconds, na.rm = TRUE), 2), 
                        ", Range: ", round(diff(range(duration_in_seconds, na.rm = TRUE)), 2)),
      Acousticness = paste0("Mean: ", round(mean(acousticness, na.rm = TRUE), 2), 
                            ", Median: ", round(median(acousticness, na.rm = TRUE), 2), 
                            ", Range: ", round(diff(range(acousticness, na.rm = TRUE)), 2)),
      Speechiness = paste0("Mean: ", round(mean(speechiness, na.rm = TRUE), 2), 
                           ", Median: ", round(median(speechiness, na.rm = TRUE), 2), 
                           ", Range: ", round(diff(range(speechiness, na.rm = TRUE)), 2))
    ) %>%
    pivot_longer(cols = everything(), names_to = "Variable", values_to = "Summary")

  kable(summary_table, caption = caption, align = "c")
}

summarize_statistics(pre_covid, "Summary Statistics for Pre-COVID Dataset")
summarize_statistics(post_covid_combined, "Summary Statistics for Post-COVID Combined Dataset (2020-2023)")

```

## Visualization for Summary Statistics

```{r}
# Pre-COVID summary statistics (Reset)
pre_covid_summary <- pre_covid %>%
  summarise(
    danceability_mean = mean(danceability, na.rm = TRUE),
    danceability_median = median(danceability, na.rm = TRUE),
    danceability_range = range(danceability, na.rm = TRUE),
    
    tempo_mean = mean(tempo, na.rm = TRUE),
    tempo_median = median(tempo, na.rm = TRUE),
    tempo_range = range(tempo, na.rm = TRUE),
    
    energy_mean = mean(energy, na.rm = TRUE),
    energy_median = median(energy, na.rm = TRUE),
    energy_range = range(energy, na.rm = TRUE),
    
    loudness_mean = mean(loudness, na.rm = TRUE),
    loudness_median = median(loudness, na.rm = TRUE),
    loudness_range = range(loudness, na.rm = TRUE),
    
    valence_mean = mean(valence, na.rm = TRUE),
    valence_median = median(valence, na.rm = TRUE),
    valence_range = range(valence, na.rm = TRUE),
    
    duration_in_seconds_mean = mean(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_median = median(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_range = range(duration_in_seconds, na.rm = TRUE),
    
    acousticness_mean = mean(acousticness, na.rm = TRUE),
    acousticness_median = median(acousticness, na.rm = TRUE),
    acousticness_range = range(acousticness, na.rm = TRUE),
    
    speechiness_mean = mean(speechiness, na.rm = TRUE),
    speechiness_median = median(speechiness, na.rm = TRUE),
    speechiness_range = range(speechiness, na.rm = TRUE)
  )

# Post-COVID combined summary statistics (Reset)
post_covid_combined_summary <- post_covid_combined %>%
  summarise(
    danceability_mean = mean(danceability, na.rm = TRUE),
    danceability_median = median(danceability, na.rm = TRUE),
    danceability_range = range(danceability, na.rm = TRUE),
    
    tempo_mean = mean(tempo, na.rm = TRUE),
    tempo_median = median(tempo, na.rm = TRUE),
    tempo_range = range(tempo, na.rm = TRUE),
    
    energy_mean = mean(energy, na.rm = TRUE),
    energy_median = median(energy, na.rm = TRUE),
    energy_range = range(energy, na.rm = TRUE),
    
    loudness_mean = mean(loudness, na.rm = TRUE),
    loudness_median = median(loudness, na.rm = TRUE),
    loudness_range = range(loudness, na.rm = TRUE),
    
    valence_mean = mean(valence, na.rm = TRUE),
    valence_median = median(valence, na.rm = TRUE),
    valence_range = range(valence, na.rm = TRUE),
    
    duration_in_seconds_mean = mean(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_median = median(duration_in_seconds, na.rm = TRUE),
    duration_in_seconds_range = range(duration_in_seconds, na.rm = TRUE),
    
    acousticness_mean = mean(acousticness, na.rm = TRUE),
    acousticness_median = median(acousticness, na.rm = TRUE),
    acousticness_range = range(acousticness, na.rm = TRUE),
    
    speechiness_mean = mean(speechiness, na.rm = TRUE),
    speechiness_median = median(speechiness, na.rm = TRUE),
    speechiness_range = range(speechiness, na.rm = TRUE)
  )

# Create a comparison data frame for visualization
comparison_df <- data.frame(
  variable = c("Danceability", "Tempo", "Energy", "Loudness", "Valence", "Duration (seconds)", "Acousticness", "Speechiness"),
  pre_covid_mean = c(pre_covid_summary$danceability_mean, pre_covid_summary$tempo_mean, pre_covid_summary$energy_mean, pre_covid_summary$loudness_mean, 
                     pre_covid_summary$valence_mean, pre_covid_summary$duration_in_seconds_mean, pre_covid_summary$acousticness_mean, pre_covid_summary$speechiness_mean),
  post_covid_mean = c(post_covid_combined_summary$danceability_mean, post_covid_combined_summary$tempo_mean, post_covid_combined_summary$energy_mean, post_covid_combined_summary$loudness_mean,
                      post_covid_combined_summary$valence_mean, post_covid_combined_summary$duration_in_seconds_mean, post_covid_combined_summary$acousticness_mean, post_covid_combined_summary$speechiness_mean)
)

# Reshape the data to long format for plotting with ggplot
comparison_long <- comparison_df %>%
  gather(key = "period", value = "mean_value", pre_covid_mean, post_covid_mean)

# Set the colors for the periods
comparison_long$period <- factor(comparison_long$period, levels = c("pre_covid_mean", "post_covid_mean"), labels = c("Pre-COVID", "Post-COVID"))

# Create the plot
p <- ggplot(comparison_long, aes(x = variable, y = mean_value, fill = period)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  facet_wrap(~ variable, scales = "free_y", ncol = 2) +  # Facet for each variable
  labs(title = "Comparison of Pre-COVID vs Post-COVID for Key Variables", x = "Variable", y = "Mean Value") +
  scale_fill_manual(values = c("Pre-COVID" = "skyblue", "Post-COVID" = "salmon")) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),        # Remove x-axis labels from each facet
        strip.text = element_text(size = 12, face = "bold"),
        strip.background = element_blank(),  # Remove the background for facet labels
        axis.title.x = element_blank())       # Remove x-axis title

# Print the plot
print(p)

```

# Distribution of Key Variables

## Danceability Visualizations

```{r}
# Create a long format dataset for combining Pre-COVID and Post-COVID data
combined_data_long <- bind_rows(
  pre_covid %>% mutate(period = "Pre-COVID"),
  post_covid_2020 %>% mutate(period = "Post-COVID"),
  post_covid_2021 %>% mutate(period = "Post-COVID"),
  post_covid_2022 %>% mutate(period = "Post-COVID"),
  post_covid_2023 %>% mutate(period = "Post-COVID")
)

# Danceability: Histogram and Density Plot with Density
p_danceability <- ggplot(combined_data_long, aes(x = danceability, fill = period, color = period)) +
  geom_histogram(aes(y = ..density..), binwidth = 0.05, position = "identity", alpha = 0.5, color = "black") +
  geom_density(alpha = 0.3) +
  labs(title = "Distribution of Danceability Scores", x = "Danceability", y = "Density") +
  scale_fill_manual(values = c("Pre-COVID" = "skyblue", "Post-COVID" = "salmon")) +
  scale_color_manual(values = c("Pre-COVID" = "blue", "Post-COVID" = "red")) +
  theme_minimal()

# Print Danceability histogram and density plot
print(p_danceability)

```

## Tempo Visualizations

```{r}
ggplot(combined_data_long, aes(x = tempo, fill = period)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution of Tempo", x = "Tempo (BPM)", y = "Density")
```

# Correlation Analysis

```{r}
# Select quantitative variables of interest for correlation analysis
quantitative_variables <- c("danceability", "tempo", "energy", "valence", "loudness", "speechiness", "acousticness")

# Calculate correlation matrix for the selected variables
correlation_matrix <- combined_data_long %>%
  select(any_of(quantitative_variables)) %>%
  cor(use = "complete.obs")  # Use only complete cases

# Adjust margins
par(mar = c(7, 5, 5, 5))  # Increase bottom margin

# Plot the correlation heatmap
corrplot(correlation_matrix, 
         method = "color",        # Use colored tiles
         type = "upper",          # Show only upper triangle
         tl.cex = 0.8,            # Text size for labels
         tl.col = "red",          # Text color for labels
         tl.srt = 45,             # Rotate labels diagonally
         addCoef.col = "black",   # Coefficient text color
         number.cex = 0.7,        # Size of coefficient text
         diag = FALSE)            # Exclude diagonal values

# Add the title fully centered at the bottom
mtext("Correlation Heatmap", side = 1, line = 5, adj = 0.5, cex = 1.5, col = "black")

```

### Line Plots: Plot Yearly Averages of Danceability and Tempo

```{r}
# Yearly averages for danceability and tempo
year_trends <- combined_data_long %>%
  group_by(year, period) %>%
  summarise(
    mean_danceability = mean(danceability, na.rm = TRUE),
    mean_tempo = mean(tempo, na.rm = TRUE)
  ) %>%
  arrange(year)

# Reshape data to a long format for ggplot
year_trends_long <- year_trends %>%
  pivot_longer(
    cols = c(mean_danceability, mean_tempo),
    names_to = "variable",
    values_to = "mean_value"
  )

# Filter data for pre-COVID
pre_covid_trends <- year_trends_long %>%
  filter(period == "Pre-COVID")

# Filter data for post-COVID
post_covid_trends <- year_trends_long %>%
  filter(period == "Post-COVID")

# Plot for pre-COVID period
ggplot(pre_covid_trends, aes(x = year, y = mean_value, color = variable)) +
  geom_line(size = 1) +
  labs(
    title = "Trends in Danceability and Tempo (Pre-COVID)",
    x = "Year", 
    y = "Mean Value"
  ) +
  scale_color_manual(
    values = c("mean_danceability" = "blue", "mean_tempo" = "green"),
    labels = c("Danceability", "Tempo")
  ) +
  theme_minimal() +
  theme(
    legend.title = element_blank(), 
    legend.position = "top"
  )

# Plot for post-COVID period
ggplot(post_covid_trends, aes(x = year, y = mean_value, color = variable)) +
  geom_line(size = 1) +
  labs(
    title = "Trends in Danceability and Tempo (Post-COVID)",
    x = "Year", 
    y = "Mean Value"
  ) +
  scale_color_manual(
    values = c("mean_danceability" = "orange", "mean_tempo" = "red"),
    labels = c("Danceability", "Tempo")
  ) +
  theme_minimal() +
  theme(
    legend.title = element_blank(), 
    legend.position = "top"
  )
```

# Outliers and Anomalies

## Boxplots

```{r}
# Boxplot for Danceability
ggplot(combined_data_long, aes(x = period, y = danceability, fill = period)) +
  geom_boxplot(outlier.colour = "red", outlier.size = 2, alpha = 0.5) +
  labs(title = "Danceability Distribution with Outliers", x = "Period", y = "Danceability") +
  scale_fill_manual(values = c("Pre-COVID" = "skyblue", "Post-COVID" = "salmon")) +
  theme_minimal()
```

```{r}
# Boxplot for Tempo
ggplot(combined_data_long, aes(x = period, y = tempo, fill = period)) +
  geom_boxplot(outlier.colour = "red", outlier.size = 2, alpha = 0.5) +
  labs(title = "Tempo Distribution with Outliers", x = "Period", y = "Tempo (BPM)") +
  scale_fill_manual(values = c("Pre-COVID" = "skyblue", "Post-COVID" = "salmon")) +
  theme_minimal()
```

## IQR

```{r}
# Calculate the IQR for Danceability and Tempo
iqr_danceability <- IQR(combined_data_long$danceability, na.rm = TRUE)
iqr_tempo <- IQR(combined_data_long$tempo, na.rm = TRUE)

# Define lower and upper bounds for outliers
lower_bound_danceability <- quantile(combined_data_long$danceability, 0.25, na.rm = TRUE) - 1.5 * iqr_danceability
upper_bound_danceability <- quantile(combined_data_long$danceability, 0.75, na.rm = TRUE) + 1.5 * iqr_danceability

lower_bound_tempo <- quantile(combined_data_long$tempo, 0.25, na.rm = TRUE) - 1.5 * iqr_tempo
upper_bound_tempo <- quantile(combined_data_long$tempo, 0.75, na.rm = TRUE) + 1.5 * iqr_tempo

# Filter outliers based on IQR
outliers_iqr_danceability <- combined_data_long %>%
  filter(danceability < lower_bound_danceability | danceability > upper_bound_danceability)

outliers_iqr_tempo <- combined_data_long %>%
  filter(tempo < lower_bound_tempo | tempo > upper_bound_tempo)

# Summarize IQR-based outliers for Danceability
summary_danceability <- outliers_iqr_danceability %>%
  group_by(period, year) %>%
  summarise(
    count = n(),
    avg_danceability = mean(danceability, na.rm = TRUE),
    min_danceability = min(danceability, na.rm = TRUE),
    max_danceability = max(danceability, na.rm = TRUE)
  )

# Summarize IQR-based outliers for Tempo
summary_tempo <- outliers_iqr_tempo %>%
  group_by(period, year) %>%
  summarise(
    count = n(),
    avg_tempo = mean(tempo, na.rm = TRUE),
    min_tempo = min(tempo, na.rm = TRUE),
    max_tempo = max(tempo, na.rm = TRUE)
  )

# Display summarized IQR-based outliers for Danceability
cat("Summarized IQR-Based Outliers for Danceability:\n")
pander(summary_danceability, caption = "Summary of Danceability Outliers (Grouped by Period and Year)")

# Display summarized IQR-based outliers for Tempo
cat("\nSummarized IQR-Based Outliers for Tempo:\n")
pander(summary_tempo, caption = "Summary of Tempo Outliers (Grouped by Period and Year)")

```

# MANOVA

```{r}
# Fit the MANOVA model
manova_model <- manova(cbind(danceability, tempo) ~ period, data = combined_data_long)

# Display MANOVA summary
cat("\n### MANOVA Results:\n")
print(summary(manova_model))

# Univariate ANOVA for Danceability
anova_danceability <- aov(danceability ~ period, data = combined_data_long)

# Display ANOVA summary for Danceability
cat("\n### Univariate ANOVA Results for Danceability:\n")
print(summary(anova_danceability))

# Univariate ANOVA for Tempo
anova_tempo <- aov(tempo ~ period, data = combined_data_long)

display_anova_results <- function(anova_model, caption) {
  tidy_results <- broom::tidy(anova_model)
  
  kable(tidy_results, 
        caption = caption, 
        align = "c")
}

# Univariate ANOVA for Tempo
anova_tempo <- aov(tempo ~ period, data = combined_data_long)

# Display ANOVA summary for Tempo
display_anova_results(anova_tempo, "Univariate ANOVA Results for Tempo")

```

## Random Forest Model Selection and Performance Evaluation

```{r}
# removing non-relevant columns and handling NA values
combined_data_model <- combined_data_long %>%
  select(danceability, tempo, energy, acousticness, liveness, loudness, speechiness, valence, year) %>%
  drop_na()  # Remove rows with missing values

# Convert 'year' to factor
combined_data_model$year <- as.factor(combined_data_model$year)

# Random Forest model for predicting danceability
rf_danceability <- randomForest(danceability ~ energy + acousticness + liveness + loudness + speechiness + valence + year, 
                                data = combined_data_model, 
                                ntree = 500, 
                                importance = TRUE)

# Random Forest model for predicting tempo
rf_tempo <- randomForest(tempo ~ energy + acousticness + liveness + loudness + speechiness + valence + year, 
                         data = combined_data_model, 
                         ntree = 500, 
                         importance = TRUE)

# Print Random Forest model summaries
cat("Danceability Model Summary:\n")
print(rf_danceability)  # Detailed Random Forest summary for Danceability

cat("\nTempo Model Summary:\n")
print(rf_tempo)  # Detailed Random Forest summary for Tempo

# Evaluate model performance using RMSE and R-squared
# Predicted values for danceability
pred_danceability <- predict(rf_danceability, combined_data_model)
rmse_danceability <- sqrt(mean((pred_danceability - combined_data_model$danceability)^2))
rsq_danceability <- 1 - sum((pred_danceability - combined_data_model$danceability)^2) / sum((mean(combined_data_model$danceability) - combined_data_model$danceability)^2)

# Predicted values for tempo
pred_tempo <- predict(rf_tempo, combined_data_model)
rmse_tempo <- sqrt(mean((pred_tempo - combined_data_model$tempo)^2))
rsq_tempo <- 1 - sum((pred_tempo - combined_data_model$tempo)^2) / sum((mean(combined_data_model$tempo) - combined_data_model$tempo)^2)

# Format RMSE and R-squared output for both models
cat(sprintf("\nDanceability Model - RMSE: %.4f, R-squared: %.4f\n", rmse_danceability, rsq_danceability))
cat(sprintf("Tempo Model - RMSE: %.4f, R-squared: %.4f\n", rmse_tempo, rsq_tempo))

```

### Evaluate model performance using RMSE and R-squared

```{r}
# Predicted values for danceability
pred_danceability <- predict(rf_danceability, combined_data_model)
rmse_danceability <- sqrt(mean((pred_danceability - combined_data_model$danceability)^2))
rsq_danceability <- 1 - sum((pred_danceability - combined_data_model$danceability)^2) / 
                      sum((mean(combined_data_model$danceability) - combined_data_model$danceability)^2)

# Predicted values for tempo
pred_tempo <- predict(rf_tempo, combined_data_model)
rmse_tempo <- sqrt(mean((pred_tempo - combined_data_model$tempo)^2))
rsq_tempo <- 1 - sum((pred_tempo - combined_data_model$tempo)^2) / 
               sum((mean(combined_data_model$tempo) - combined_data_model$tempo)^2)

results_table <- data.frame(
  Model = c("Danceability", "Tempo"),
  RMSE = c(rmse_danceability, rmse_tempo),
  R_Squared = c(rsq_danceability, rsq_tempo)
)

kable(results_table, 
      caption = "Model Performance Metrics (RMSE and R-Squared)", 
      align = "c")

```

### Unsupervised

# K-means clustering for danceability and tempo
```{r}
set.seed(123)  # For reproducibility

# Subset the data for danceability and tempo
danceability_tempo_data <- combined_data_long %>%
  select(danceability, tempo, period)

kmeans_dance_tempo <- kmeans(danceability_tempo_data[, c("danceability", "tempo")], centers = 3, nstart = 20)

# Add cluster labels to the data
danceability_tempo_data$cluster <- as.factor(kmeans_dance_tempo$cluster)

ggplot(danceability_tempo_data, aes(x = danceability, y = tempo, color = cluster, shape = period)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    title = "K-means Clustering of Danceability and Tempo",
    x = "Danceability",
    y = "Tempo (BPM)"
  ) +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    legend.position = "top"
  )

```

## K-Means Clustering with Pre-COVID vs. Post-COVID Comparison

```{r}
pre_covid_clustering_data <- pre_covid %>%
  select(danceability, tempo, energy, loudness, speechiness, valence, acousticness) %>%
  drop_na()

post_covid_clustering_data <- post_covid_combined %>%
  select(danceability, tempo, energy, loudness, speechiness, valence, acousticness) %>%
  drop_na()

# Scale the data
scaled_pre_covid <- scale(pre_covid_clustering_data)
scaled_post_covid <- scale(post_covid_clustering_data)

# Determine optimal clusters for each dataset (using the Elbow Method)
wss_pre_covid <- sapply(1:10, function(k) {
  kmeans(scaled_pre_covid, centers = k, nstart = 25)$tot.withinss
})

wss_post_covid <- sapply(1:10, function(k) {
  kmeans(scaled_post_covid, centers = k, nstart = 25)$tot.withinss
})

# Plot Elbow Curves
par(mfrow = c(1, 2))  # Side-by-side plots
plot(1:10, wss_pre_covid, type = "b", pch = 19, frame = FALSE,
     xlab = "Number of Clusters", ylab = "WSS", main = "Pre-COVID Elbow Method")
plot(1:10, wss_post_covid, type = "b", pch = 19, frame = FALSE,
     xlab = "Number of Clusters", ylab = "WSS", main = "Post-COVID Elbow Method")

# Perform K-Means clustering 
set.seed(123)  # Reproducibility
kmeans_pre_covid <- kmeans(scaled_pre_covid, centers = 3, nstart = 25)
kmeans_post_covid <- kmeans(scaled_post_covid, centers = 3, nstart = 25)

# Add cluster assignments to the datasets
pre_covid$cluster <- as.factor(kmeans_pre_covid$cluster)
post_covid_combined$cluster <- as.factor(kmeans_post_covid$cluster)

# cluster characteristics for each period
pre_covid_cluster_summary <- pre_covid %>%
  group_by(cluster) %>%
  summarise(
    avg_danceability = mean(danceability, na.rm = TRUE),
    avg_tempo = mean(tempo, na.rm = TRUE),
    avg_energy = mean(energy, na.rm = TRUE),
    avg_loudness = mean(loudness, na.rm = TRUE),
    avg_speechiness = mean(speechiness, na.rm = TRUE),
    avg_valence = mean(valence, na.rm = TRUE),
    avg_acousticness = mean(acousticness, na.rm = TRUE)
  )

post_covid_cluster_summary <- post_covid_combined %>%
  group_by(cluster) %>%
  summarise(
    avg_danceability = mean(danceability, na.rm = TRUE),
    avg_tempo = mean(tempo, na.rm = TRUE),
    avg_energy = mean(energy, na.rm = TRUE),
    avg_loudness = mean(loudness, na.rm = TRUE),
    avg_speechiness = mean(speechiness, na.rm = TRUE),
    avg_valence = mean(valence, na.rm = TRUE),
    avg_acousticness = mean(acousticness, na.rm = TRUE)
  )

# cluster assignments using PCA
pca_pre_covid <- prcomp(scaled_pre_covid)
pca_post_covid <- prcomp(scaled_post_covid)

pca_pre_covid_data <- data.frame(pca_pre_covid$x[, 1:2], Cluster = pre_covid$cluster)
pca_post_covid_data <- data.frame(pca_post_covid$x[, 1:2], Cluster = post_covid_combined$cluster)

ggplot(pca_pre_covid_data, aes(x = PC1, y = PC2, color = Cluster)) +
  geom_point(alpha = 0.7) +
  labs(title = "Pre-COVID Clustering Visualization (PCA)", x = "Principal Component 1", y = "Principal Component 2") +
  theme_minimal() +
  scale_color_manual(values = c("blue", "green", "red"))

ggplot(pca_post_covid_data, aes(x = PC1, y = PC2, color = Cluster)) +
  geom_point(alpha = 0.7) +
  labs(title = "Post-COVID Clustering Visualization (PCA)", x = "Principal Component 1", y = "Principal Component 2") +
  theme_minimal() +
  scale_color_manual(values = c("blue", "green", "red"))

# Compare cluster proportions between pre-COVID and post-COVID
cluster_proportions <- data.frame(
  Period = c(rep("Pre-COVID", 3), rep("Post-COVID", 3)),
  Cluster = c(1, 2, 3, 1, 2, 3),
  Proportion = c(
    prop.table(table(kmeans_pre_covid$cluster)),
    prop.table(table(kmeans_post_covid$cluster))
  )
)

ggplot(cluster_proportions, aes(x = Cluster, y = Proportion, fill = Period)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Cluster Proportions: Pre-COVID vs Post-COVID", x = "Cluster", y = "Proportion") +
  scale_fill_manual(values = c("Pre-COVID" = "skyblue", "Post-COVID" = "salmon")) +
  theme_minimal()

kable(pre_covid_cluster_summary, caption = "Pre-COVID Cluster Summary", align = "c")
kable(post_covid_cluster_summary, caption = "Post-COVID Cluster Summary", align = "c")

```



